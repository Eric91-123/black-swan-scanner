<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>é»‘å¤©é¹…è‚¡ç¥¨æ‰«æå™¨ V2</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto; background: #f7f8fa; padding: 20px; }
    h1, h2 { margin-bottom: 10px; }
    button { padding: 8px 14px; font-size: 14px; cursor: pointer; margin-bottom: 15px; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin-bottom: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #f0f2f5; }
    .score { font-weight: bold; }
    #stockInput { padding: 6px 10px; font-size: 14px; width: 200px; }
    #analysisOutput { background: #fff; padding: 10px; border: 1px solid #ddd; margin-top: 10px; }
  </style>
</head>

<body>
<h1>ğŸ“‰ é»‘å¤©é¹…è‚¡ç¥¨æ‰«æå™¨ï¼ˆV2 Â· Finnhubï¼‰</h1>

<!-- æ‰«ææ¨èè‚¡ç¥¨ -->
<h2>æ‰«ææ¨èè‚¡ç¥¨ï¼ˆè¿‡å»ä¸€å¹´è·Œå¹… â‰¥30%ï¼‰</h2>
<button onclick="scanStocks()">æ‰«ææ¨èè‚¡ç¥¨</button>
<table id="stockTable">
  <thead>
    <tr>
      <th>ä»£ç </th>
      <th>å…¬å¸</th>
      <th>æœ€æ–°ä»·</th>
      <th>å¹´è·Œå¹…</th>
      <th>è¯„åˆ†</th>
      <th>åˆ†æç»“è®º</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="6">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åŠ è½½æ•°æ®</td></tr>
  </tbody>
</table>

<!-- å•åªè‚¡ç¥¨åˆ†æ -->
<h2>å•åªè‚¡ç¥¨è¯¦ç»†åˆ†æ</h2>
<input type="text" id="stockInput" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç ï¼ˆå¦‚AAPLï¼‰">
<button onclick="analyzeStock()">åˆ†æ</button>
<div id="analysisOutput">åˆ†æç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>

<script>
const API_KEY = "d5ljrhhr01qlna889r6gd5ljrhhr01qlna889r70";

// ç¤ºä¾‹æ¨èè‚¡ç¥¨åˆ—è¡¨ï¼ˆå¯æ›¿æ¢æˆ–æ‰©å±•åˆ°æ›´å¤šï¼‰
const SYMBOLS = [
  { symbol: "AAPL", name: "Apple" },
  { symbol: "MSFT", name: "Microsoft" },
  { symbol: "TSLA", name: "Tesla" },
  { symbol: "AMZN", name: "Amazon" },
  { symbol: "META", name: "Meta" },
  { symbol: "NVDA", name: "NVIDIA" },
  { symbol: "GOOGL", name: "Alphabet" },
  { symbol: "NFLX", name: "Netflix" },
  { symbol: "INTC", name: "Intel" },
  { symbol: "AMD", name: "AMD" },
  { symbol: "BABA", name: "Alibaba" },
  { symbol: "JD", name: "JD.com" },
  { symbol: "PYPL", name: "Paypal" },
  { symbol: "UBER", name: "Uber" },
  { symbol: "DIS", name: "Disney" },
  { symbol: "SHOP", name: "Shopify" },
  { symbol: "SQ", name: "Block" },
  { symbol: "CRM", name: "Salesforce" },
  { symbol: "ORCL", name: "Oracle" },
  { symbol: "IBM", name: "IBM" }
];

// è¾…åŠ©å‡½æ•°ï¼šè°ƒç”¨Finnhubå†å²ä»·æ ¼
async function fetchStockHistory(symbol) {
  const now = Math.floor(Date.now() / 1000);
  const oneYearAgo = now - 365*24*60*60;
  const url = `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${oneYearAgo}&to=${now}&token=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();
  if (data.s !== "ok") throw new Error("æ•°æ®è·å–å¤±è´¥");
  return data;
}

// æ‰«ææ¨èè‚¡ç¥¨
async function scanStocks() {
  const tbody = document.querySelector("#stockTable tbody");
  tbody.innerHTML = "";
  for (const stock of SYMBOLS) {
    try {
      const history = await fetchStockHistory(stock.symbol);
      const firstClose = history.c[0];
      const lastClose = history.c[history.c.length - 1];
      const yearlyDrop = ((firstClose - lastClose)/firstClose)*100;

      if (yearlyDrop < 30) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${stock.symbol}</td><td>${stock.name}</td><td>${lastClose.toFixed(2)}</td><td>${yearlyDrop.toFixed(2)}%</td><td>-</td><td>æœªè¾¾åˆ°ç­›é€‰æ¡ä»¶</td>`;
        tbody.appendChild(tr);
        continue;
      }

      // ç®€å•è¯„åˆ†ï¼ˆå¯æ‰©å±•æ›´å¤æ‚ç®—æ³•ï¼‰
      let score = 100 - yearlyDrop;
      let conclusion = "å¯èƒ½æœ‰åå¼¹æœºä¼š";

      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${stock.symbol}</td><td>${stock.name}</td><td>${lastClose.toFixed(2)}</td><td>${yearlyDrop.toFixed(2)}%</td><td>${score.toFixed(0)}</td><td>${conclusion}</td>`;
      tbody.appendChild(tr);

    } catch (err) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${stock.symbol}</td><td colspan="5">æ•°æ®åŠ è½½å¤±è´¥</td>`;
      tbody.appendChild(tr);
    }
  }
}

// å•åªè‚¡ç¥¨è¯¦ç»†åˆ†æ
async function analyzeStock() {
  const symbol = document.getElementById("stockInput").value.trim().toUpperCase();
  const output = document.getElementById("analysisOutput");
  output.innerHTML = "åˆ†æä¸­...";
  if (!symbol) {
    output.innerHTML = "è¯·è¾“å…¥æœ‰æ•ˆè‚¡ç¥¨ä»£ç ";
    return;
  }

  try {
    const history = await fetchStockHistory(symbol);
    const firstClose = history.c[0];
    const lastClose = history.c[history.c.length - 1];
    const yearlyDrop = ((firstClose - lastClose)/firstClose)*100;

    // åŸºç¡€ä¿¡æ¯ + ç®€å•åˆ†æ
    let report = `<h3>${symbol} åˆ†ææŠ¥å‘Š</h3>`;
    report += `<p>è¿‡å»ä¸€å¹´æ”¶ç›˜ä»·è·Œå¹…ï¼š${yearlyDrop.toFixed(2)}%</p>`;
    report += `<p>è‚¡ç¥¨ç”Ÿå­˜èƒ½åŠ›ï¼š${yearlyDrop > 50 ? "âš ï¸ é£é™©è¾ƒé«˜" : "æ­£å¸¸"}</p>`;
    report += `<p>ä¼°å€¼ä¸æƒ…ç»ªåˆ¤æ–­ï¼šç®€å•åŸºäºè·Œå¹…è¯„åˆ†</p>`;
    report += `<p>ç»¼åˆç»“è®ºï¼š${yearlyDrop > 30 ? "å¯èƒ½å­˜åœ¨åå¼¹æœºä¼š" : "æš‚æ— æ˜æ˜¾é»‘å¤©é¹…é£é™©"}</p>`;
    report += `<p>å»ºè®®è·Ÿè¸ªï¼šæŒç»­è§‚å¯Ÿé‡å¤§æ–°é—»åŠè´¢æŠ¥</p>`;

    output.innerHTML = report;

  } catch (err) {
    output.innerHTML = "åˆ†æå¤±è´¥ï¼šè·å–æ•°æ®å¤±è´¥";
  }
}
</script>
</body>
</html>
