<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Black Swan Scanner Â· V1</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
      background: #f7f8fa;
      padding: 20px;
    }
    h1 {
      margin-bottom: 10px;
    }
    button {
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
    }
    table {
      margin-top: 20px;
      border-collapse: collapse;
      width: 100%;
      background: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 13px;
    }
    th {
      background: #f0f2f5;
    }
    .danger {
      background: #ffecec;
      color: #c40000;
      font-weight: bold;
    }
    .warn {
      background: #fff7e6;
      color: #ad6800;
      font-weight: bold;
    }
    .ok {
      color: #389e0d;
    }
  </style>
</head>

<body>

<h1>ğŸ“‰ Black Swan Scanner Â· V1</h1>
<p>è§„åˆ™ï¼šå•æ—¥è·Œå¹… â‰¤ -8% æˆ– æˆäº¤é‡ â‰¥ 10æ—¥å‡é‡ 2å€</p>
<button onclick="scan()">å¼€å§‹æ‰«æ</button>

<table>
  <thead>
    <tr>
      <th>ä»£ç </th>
      <th>æœ€æ–°ä»·</th>
      <th>æ˜¨æ”¶</th>
      <th>æ¶¨è·Œå¹…</th>
      <th>æˆäº¤é‡</th>
      <th>10æ—¥å‡é‡</th>
      <th>çŠ¶æ€</th>
    </tr>
  </thead>
  <tbody id="result"></tbody>
</table>

<script>
const FINNHUB_API_KEY = "d5ljrhhr01qlna889r6gd5ljrhhr01qlna889r70";

// ä½ å¯ä»¥è‡ªå·±éšä¾¿åŠ 
const SYMBOLS = [
  "AAPL",
  "TSLA",
  "NVDA",
  "META",
  "AMZN",
  "MSFT"
];

async function fetchJSON(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error("API è¯·æ±‚å¤±è´¥");
  return res.json();
}

async function scan() {
  const tbody = document.getElementById("result");
  tbody.innerHTML = "";

  for (const symbol of SYMBOLS) {
    try {
      // 1ï¸âƒ£ å®æ—¶è¡Œæƒ…
      const quote = await fetchJSON(
        `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_API_KEY}`
      );

      // 2ï¸âƒ£ å†å²æˆäº¤é‡ï¼ˆè¿‘ 10 å¤©ï¼‰
      const now = Math.floor(Date.now() / 1000);
      const tenDaysAgo = now - 60 * 60 * 24 * 20;

      const candle = await fetchJSON(
        `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${tenDaysAgo}&to=${now}&token=${FINNHUB_API_KEY}`
      );

      let avgVolume = "â€”";
      let volumeFlag = false;

      if (candle.s === "ok" && candle.v.length >= 10) {
        const vols = candle.v.slice(-10);
        avgVolume = Math.round(vols.reduce((a, b) => a + b, 0) / vols.length);
        volumeFlag = quote.v >= avgVolume * 2;
      }

      const changePct = quote.dp;
      const priceFlag = changePct <= -8;

      let status = "æ­£å¸¸";
      let rowClass = "ok";

      if (priceFlag && volumeFlag) {
        status = "ğŸš¨ é»‘å¤©é¹…ï¼ˆæš´è·Œ + æ”¾é‡ï¼‰";
        rowClass = "danger";
      } else if (priceFlag) {
        status = "âš ï¸ æš´è·Œ";
        rowClass = "warn";
      } else if (volumeFlag) {
        status = "âš ï¸ æ”¾é‡å¼‚å¸¸";
        rowClass = "warn";
      }

      const tr = document.createElement("tr");
      tr.className = rowClass;
      tr.innerHTML = `
        <td>${symbol}</td>
        <td>${quote.c}</td>
        <td>${quote.pc}</td>
        <td>${changePct.toFixed(2)}%</td>
        <td>${quote.v.toLocaleString()}</td>
        <td>${avgVolume === "â€”" ? "â€”" : avgVolume.toLocaleString()}</td>
        <td>${status}</td>
      `;
      tbody.appendChild(tr);

    } catch (e) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${symbol}</td>
        <td colspan="6">æ•°æ®åŠ è½½å¤±è´¥</td>
      `;
      tbody.appendChild(tr);
    }
  }
}
</script>

</body>
</html>
