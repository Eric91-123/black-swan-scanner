<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>黑天鹅股票扫描仪</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  th { background-color: #f2f2f2; }
  input, button { padding: 5px; margin: 5px; }
  #log { margin-top: 10px; color: red; }
</style>
</head>
<body>

<h1>黑天鹅股票扫描仪</h1>

<button id="scanBtn">扫描过去一年跌幅超过30%的股票</button>
<br>
<input type="text" id="singleStock" placeholder="输入股票代码，例如AAPL">
<button id="analyzeBtn">分析股票</button>

<div id="log"></div>

<table id="resultsTable">
  <thead>
    <tr>
      <th>股票代码</th>
      <th>跌幅%</th>
      <th>回升评分</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="singleAnalysis"></div>

<script>
const API_KEY = "d5ljrhhr01qlna889r6gd5ljrhhr01qlna889r70";
const STOCKS_LIST = ["AAPL", "MSFT", "GOOGL", "AMZN", "TSLA", "META", "NVDA", "NFLX", "BABA", "INTC", "CSCO", "ORCL", "IBM", "ADBE", "PYPL", "SHOP", "QCOM", "AMD", "TXN", "CRM"];

const log = (msg) => { document.getElementById('log').innerText = msg; }

async function fetchStockData(symbol, from, to) {
  const url = `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${from}&to=${to}&token=${API_KEY}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    console.log(symbol, data); // 调试打印
    return data;
  } catch (err) {
    console.error(err);
    return null;
  }
}

function calculateDrop(data) {
  if (!data || data.s !== "ok" || !data.c || data.c.length < 2) return null;
  const start = data.c[0];
  const end = data.c[data.c.length - 1];
  const drop = ((start - end) / start) * 100;
  return drop.toFixed(2);
}

function scoreRecovery(drop) {
  // 简单示例：跌幅越大，回升评分越高
  return Math.min(Math.max(100 + drop, 0), 100).toFixed(0);
}

async function scanStocks() {
  log("扫描中，请稍等...");
  const tbody = document.querySelector("#resultsTable tbody");
  tbody.innerHTML = "";
  const now = Math.floor(Date.now() / 1000);
  const oneYearAgo = now - 365 * 24 * 3600;

  const results = [];

  for (const symbol of STOCKS_LIST) {
    const data = await fetchStockData(symbol, oneYearAgo, now);
    const drop = calculateDrop(data);
    if (drop !== null && drop >= 30) {
      const score = scoreRecovery(drop);
      results.push({ symbol, drop, score });
    }
  }

  if (results.length === 0) {
    log("未发现符合条件的股票");
    return;
  }

  // 按评分排序，取前20
  results.sort((a,b) => b.score - a.score);
  const top20 = results.slice(0, 20);

  for (const r of top20) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.symbol}</td><td>${r.drop}%</td><td>${r.score}</td>`;
    tbody.appendChild(tr);
  }
  log(`扫描完成，发现${top20.length}只符合条件的股票`);
}

async function analyzeSingleStock() {
  const symbol = document.getElementById("singleStock").value.trim().toUpperCase();
  if (!symbol) {
    log("请输入股票代码");
    return;
  }

  log("分析中，请稍等...");
  const now = Math.floor(Date.now() / 1000);
  const oneYearAgo = now - 365 * 24 * 3600;

  const data = await fetchStockData(symbol, oneYearAgo, now);
  if (!data || data.s !== "ok") {
    document.getElementById("singleAnalysis").innerText = "分析失败：获取数据失败";
    return;
  }

  const drop = calculateDrop(data);
  const score = scoreRecovery(drop);
  const analysis = `
    <h2>${symbol} 分析报告</h2>
    <ul>
      <li>过去一年跌幅: ${drop}%</li>
      <li>回升评分: ${score}</li>
      <li>基础信息: 待扩展</li>
      <li>黑天鹅事件分析: 待扩展</li>
      <li>股票生存能力评估: 待扩展</li>
      <li>估值与市场情绪判断: 待扩展</li>
      <li>综合结论与跟踪: 待扩展</li>
    </ul>
  `;
  document.getElementById("singleAnalysis").innerHTML = analysis;
  log("分析完成");
}

document.getElementById("scanBtn").addEventListener("click", scanStocks);
document.getElementById("analyzeBtn").addEventListener("click", analyzeSingleStock);
</script>

</body>
</html>
