<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>é»‘å¤©é¹…è‚¡ç¥¨æ‰«æå™¨ V2</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
      background: #f7f8fa;
      padding: 20px;
    }
    h1 { margin-bottom: 10px; }
    button {
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 15px;
    }
    input { padding: 6px; margin-right: 8px; }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th { background: #f0f2f5; }
    .score { font-weight: bold; }
  </style>
</head>

<body>
<h1>ğŸ“‰ é»‘å¤©é¹…è‚¡ç¥¨æ‰«æå™¨ï¼ˆV2 Â· å¹´åº¦è·Œå¹…30%ä»¥ä¸Šï¼‰</h1>

<!-- æ‰«ææŒ‰é’® -->
<button onclick="scanStocks()">æ‰«æå¹´åº¦è·Œå¹…â‰¥30%è‚¡ç¥¨</button>

<!-- å®šå‘è‚¡ç¥¨åˆ†æ -->
<input type="text" id="customSymbol" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œä¾‹å¦‚AAPL" />
<button onclick="analyzeStock()">åˆ†ææŒ‡å®šè‚¡ç¥¨</button>

<!-- æ‰«æç»“æœè¡¨ -->
<h2>å¹´åº¦è·Œå¹…â‰¥30%è‚¡ç¥¨æ¸…å•</h2>
<table id="stockTable">
  <thead>
    <tr>
      <th>ä»£ç </th>
      <th>å…¬å¸</th>
      <th>æœ€æ–°ä»·</th>
      <th>è·Œå¹…</th>
      <th>æˆäº¤é‡</th>
      <th>é£é™©çŠ¶æ€</th>
      <th>åˆ†æç»“è®º</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td colspan="7">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ‰«ææ•°æ®</td>
    </tr>
  </tbody>
</table>

<!-- å®šå‘åˆ†æç»“æœ -->
<h2>å®šå‘è‚¡ç¥¨åˆ†ææŠ¥å‘Š</h2>
<div id="customReport">è¾“å…¥è‚¡ç¥¨ä»£ç å¹¶ç‚¹å‡»åˆ†ææŒ‰é’®</div>

<script>
const SYMBOLS = [
  { symbol: "AAPL.US", name: "Apple" },
  { symbol: "MSFT.US", name: "Microsoft" },
  { symbol: "TSLA.US", name: "Tesla" },
  { symbol: "AMZN.US", name: "Amazon" },
  { symbol: "META.US", name: "Meta" },
  { symbol: "GOOGL.US", name: "Alphabet" },
  { symbol: "NVDA.US", name: "NVIDIA" },
  { symbol: "NFLX.US", name: "Netflix" },
  { symbol: "BABA.US", name: "Alibaba" },
  { symbol: "JPM.US", name: "JP Morgan" },
  { symbol: "DIS.US", name: "Disney" },
  { symbol: "ADBE.US", name: "Adobe" },
  { symbol: "PYPL.US", name: "PayPal" },
  { symbol: "INTC.US", name: "Intel" },
  { symbol: "CSCO.US", name: "Cisco" },
  { symbol: "ORCL.US", name: "Oracle" },
  { symbol: "CRM.US", name: "Salesforce" },
  { symbol: "UBER.US", name: "Uber" },
  { symbol: "LYFT.US", name: "Lyft" },
  { symbol: "SQ.US", name: "Block" }
];

const FINNHUB_KEY = "d5ljrhhr01qlna889r6gd5ljrhhr01qlna889r70";

// è°ƒç”¨ Finnhub API è·å–è‚¡ç¥¨å†å²æ•°æ®
async function fetchStockHistory(symbol, resolution="D", from, to) {
  const url = `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=${resolution}&from=${from}&to=${to}&token=${FINNHUB_KEY}`;
  const res = await fetch(url);
  return res.json();
}

// æ‰«æå¹´åº¦è·Œå¹…â‰¥30%è‚¡ç¥¨
async function scanStocks() {
  const tbody = document.querySelector("#stockTable tbody");
  tbody.innerHTML = "";

  const now = Math.floor(Date.now() / 1000);
  const oneYearAgo = now - 365 * 24 * 3600;

  for (const stock of SYMBOLS) {
    try {
      const data = await fetchStockHistory(stock.symbol, "D", oneYearAgo, now);

      if (data.s !== "ok" || !data.c || data.c.length < 2) throw new Error("æ•°æ®ç¼ºå¤±");

      const oneYearAgoPrice = data.c[0];
      const currentPrice = data.c[data.c.length - 1];

      const dropPct = ((oneYearAgoPrice - currentPrice) / oneYearAgoPrice) * 100;

      if (dropPct < 30) continue; // ä¸æ»¡è¶³å¹´åº¦è·Œå¹…â‰¥30%

      // ç®€å•æ‰“åˆ†é€»è¾‘ï¼šè·Œå¹…è¶Šå¤§ï¼Œå›å‡æ½œåŠ›åˆ†è¶Šé«˜
      let score = Math.min(Math.max(dropPct / 2, 1), 10);
      let status = score > 7 ? "âš ï¸ é«˜é£é™©è§‚å¯Ÿ" : "æ­£å¸¸";
      let conclusion = score > 7 ? "å…³æ³¨æ½œåœ¨é»‘å¤©é¹…äº‹ä»¶" : "æœªå‘ç°é‡å¤§é£é™©";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${stock.symbol.replace(".US","")}</td>
        <td>${stock.name}</td>
        <td>${currentPrice.toFixed(2)}</td>
        <td>${dropPct.toFixed(2)}%</td>
        <td>-</td>
        <td class="score">${status}</td>
        <td>${conclusion}</td>
      `;
      tbody.appendChild(tr);

    } catch (err) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${stock.symbol.replace(".US","")}</td><td colspan="6">æ•°æ®åŠ è½½å¤±è´¥</td>`;
      tbody.appendChild(tr);
    }
  }

  if (tbody.innerHTML.trim() === "") {
    tbody.innerHTML = `<tr><td colspan="7">æœªå‘ç°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨</td></tr>`;
  }
}

// å®šå‘è‚¡ç¥¨åˆ†æï¼ˆåŸºç¡€æŠ¥å‘Šï¼‰
async function analyzeStock() {
  const symbol = document.getElementById("customSymbol").value.trim();
  const reportDiv = document.getElementById("customReport");
  reportDiv.innerHTML = "åŠ è½½ä¸­...";

  if (!symbol) {
    reportDiv.innerHTML = "è¯·è¾“å…¥æœ‰æ•ˆè‚¡ç¥¨ä»£ç ";
    return;
  }

  try {
    const now = Math.floor(Date.now() / 1000);
    const oneYearAgo = now - 365 * 24 * 3600;
    const data = await fetchStockHistory(symbol, "D", oneYearAgo, now);

    if (data.s !== "ok") throw new Error("è·å–æ•°æ®å¤±è´¥");

    const currentPrice = data.c[data.c.length - 1];
    const oneYearAgoPrice = data.c[0];
    const dropPct = ((oneYearAgoPrice - currentPrice) / oneYearAgoPrice) * 100;

    reportDiv.innerHTML = `
      <strong>è‚¡ç¥¨ä»£ç ï¼š</strong>${symbol}<br/>
      <strong>æœ€æ–°ä»·ï¼š</strong>${currentPrice.toFixed(2)}<br/>
      <strong>å¹´åº¦è·Œå¹…ï¼š</strong>${dropPct.toFixed(2)}%<br/>
      <strong>é»‘å¤©é¹…äº‹ä»¶åˆ†æï¼š</strong>æ¨¡æ‹Ÿåˆ†ææ½œåœ¨é£é™©äº‹ä»¶<br/>
      <strong>ç”Ÿå­˜èƒ½åŠ›è¯„ä¼°ï¼š</strong>ä¸­ç­‰<br/>
      <strong>ä¼°å€¼ä¸å¸‚åœºæƒ…ç»ªï¼š</strong>å‚è€ƒè¿‘æœŸå¸‚åœºæ³¢åŠ¨<br/>
      <strong>ç»¼åˆç»“è®ºï¼š</strong>${dropPct >= 30 ? "é«˜é£é™©ï¼Œéœ€è¦è·Ÿè¸ª" : "é£é™©è¾ƒä½"}
    `;

  } catch (err) {
    reportDiv.innerHTML = `åˆ†æå¤±è´¥ï¼š${err.message}`;
  }
}
</script>

</body>
</html>
