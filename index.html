<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>黑天鹅股票扫描仪</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
button { margin: 5px; padding: 10px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
th { background-color: #f4f4f4; }
#report { margin-top: 30px; border: 1px solid #ccc; padding: 15px; }
</style>
</head>
<body>
<h1>黑天鹅股票扫描仪</h1>

<button id="scanBtn">扫描股票清单</button>

<h2>扫描结果</h2>
<table id="resultTable">
  <thead>
    <tr>
      <th>代码</th>
      <th>过去一年跌幅%</th>
      <th>评分</th>
      <th>综合结论</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<h2>单只股票分析</h2>
<input type="text" id="singleSymbol" placeholder="输入股票代码，例如 AAPL">
<button id="analyzeBtn">分析</button>

<div id="report"></div>

<script>
const API_KEY = 'd5ljrhhr01qlna889r6gd5ljrhhr01qlna889r70'; 
const SYMBOLS = ['AAPL','MSFT','GOOGL','AMZN','TSLA','META','NVDA','JPM','V','PG','DIS','NFLX','BABA','INTC','CSCO','ADBE','CRM','ORCL','PYPL','QCOM']; // 可扩展列表

const ONE_YEAR_SEC = 365 * 24 * 60 * 60;
const now = Math.floor(Date.now()/1000);
const oneYearAgo = now - ONE_YEAR_SEC;

async function fetchCandle(symbol) {
  const url = `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${oneYearAgo}&to=${now}&token=${API_KEY}`;
  const res = await fetch(url);
  const data = await res.json();
  if(data.s !== 'ok') return null;
  return data;
}

function calculateDrop(data) {
  const startPrice = data.c[0];
  const endPrice = data.c[data.c.length - 1];
  return ((startPrice - endPrice)/startPrice * 100).toFixed(2);
}

function scoreStock(dropPct) {
  // 简单打分：跌幅越大，评分越高
  let score = Math.min(Math.max(dropPct,0),100);
  return score;
}

function conclusion(score) {
  if(score >= 50) return '强烈关注';
  if(score >= 30) return '关注';
  return '观察';
}

document.getElementById('scanBtn').addEventListener('click', async ()=>{
  const tbody = document.querySelector('#resultTable tbody');
  tbody.innerHTML = '';
  let results = [];
  for(const symbol of SYMBOLS){
    const data = await fetchCandle(symbol);
    if(!data) continue;
    const drop = calculateDrop(data);
    if(drop >= 30) { // 过去一年跌幅>=30%
      const sc = scoreStock(drop);
      results.push({symbol, drop, score: sc, concl: conclusion(sc)});
    }
  }
  results.sort((a,b)=>b.score - a.score);
  results.slice(0,20).forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.symbol}</td><td>${r.drop}</td><td>${r.score}</td><td>${r.concl}</td>`;
    tbody.appendChild(tr);
  });
  if(results.length===0){
    tbody.innerHTML='<tr><td colspan="4">未发现符合条件的股票</td></tr>';
  }
});

document.getElementById('analyzeBtn').addEventListener('click', async ()=>{
  const symbol = document.getElementById('singleSymbol').value.toUpperCase();
  const reportDiv = document.getElementById('report');
  reportDiv.innerHTML = '加载中...';
  const data = await fetchCandle(symbol);
  if(!data){
    reportDiv.innerHTML = '分析失败：获取数据失败';
    return;
  }
  const drop = calculateDrop(data);
  const score = scoreStock(drop);
  const concl = conclusion(score);
  // 生成分析报告
  reportDiv.innerHTML = `
    <h3>${symbol} 分析报告</h3>
    <p><strong>过去一年跌幅：</strong>${drop}%</p>
    <p><strong>黑天鹅事件评分：</strong>${score}</p>
    <p><strong>综合结论：</strong>${concl}</p>
    <p><strong>股票基础信息：</strong>请在后续接入 Finnhub / Stooq 基本信息 API</p>
    <p><strong>黑天鹅事件分析：</strong>待升级：可结合新闻 / 财报 / 风险事件</p>
    <p><strong>生存能力评估：</strong>待升级：可结合财务指标 / 行业趋势</p>
    <p><strong>估值与情绪判断：</strong>待升级：可结合市盈率、舆情指标</p>
    <p><strong>跟踪建议：</strong>监控近期价格波动和重大新闻</p>
  `;
});
</script>
</body>
</html>
