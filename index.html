<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>é»‘å¤©é¹…è‚¡ç¥¨æ‰«æå™¨ Â· V2</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
      background: #f7f8fa;
      padding: 20px;
    }
    h1 { margin-bottom: 10px; }
    button {
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
      font-size: 13px;
    }
    th { background: #f0f2f5; }
    .score { font-weight: bold; }
    .danger { color: #d4380d; }
  </style>
</head>

<body>

<h1>ğŸ“‰ é»‘å¤©é¹…è‚¡ç¥¨æ‰«æå™¨ï¼ˆV2 Â· 30% è·Œå¹…ç­›é€‰ï¼‰</h1>
<button onclick="scanStocks()">å¼€å§‹æ‰«æ</button>

<table>
  <thead>
    <tr>
      <th>ä»£ç </th>
      <th>30æ—¥è·Œå¹…</th>
      <th>æœ€æ–°ä»·</th>
      <th>è¯„åˆ†</th>
      <th>çŠ¶æ€</th>
      <th>ç»“è®º</th>
    </tr>
  </thead>
  <tbody id="resultBody">
    <tr><td colspan="6">ç‚¹å‡»æŒ‰é’®å¼€å§‹æ‰«æ</td></tr>
  </tbody>
</table>

<script>
const API_KEY = "d5ljrhhr01qlna889r6gd5ljrhhr01qlna889r70";

const SYMBOLS = [
  "AAPL","MSFT","AMZN","META","TSLA",
  "NVDA","AMD","NFLX","BABA","PYPL",
  "INTC","UBER","COIN","SNAP","SHOP",
  "BA","DIS","SQ","PLTR","ROKU"
];

function toUnix(daysAgo = 0) {
  return Math.floor(Date.now() / 1000) - daysAgo * 86400;
}

async function fetchCandles(symbol) {
  const url = `https://finnhub.io/api/v1/stock/candle?symbol=${symbol}&resolution=D&from=${toUnix(45)}&to=${toUnix()}&token=${API_KEY}`;
  const res = await fetch(url);
  return res.json();
}

function scoreStock(candles) {
  const closes = candles.c;
  const volumes = candles.v;

  const first = closes[0];
  const last = closes[closes.length - 1];
  const dropPct = (first - last) / first;

  let score = 0;

  // è·Œå¹…è¯„åˆ†ï¼ˆ40ï¼‰
  score += Math.min(40, dropPct * 100 * 1.3);

  // æ”¾é‡ææ…Œï¼ˆ30ï¼‰
  const avgVol = volumes.slice(0, 20).reduce((a,b)=>a+b,0)/20;
  const recentVol = volumes.slice(-5).reduce((a,b)=>a+b,0)/5;
  if (recentVol > avgVol * 1.3) score += 30;

  // æ˜¯å¦æ­¢è·Œï¼ˆ30ï¼‰
  const last5 = closes.slice(-5);
  if (last5[4] >= last5[0]) score += 30;

  return Math.round(score);
}

async function scanStocks() {
  const tbody = document.getElementById("resultBody");
  tbody.innerHTML = "";

  let results = [];

  for (const symbol of SYMBOLS) {
    try {
      const data = await fetchCandles(symbol);
      if (data.s !== "ok" || data.c.length < 20) continue;

      const closes = data.c;
      const dropPct = (closes[0] - closes[closes.length - 1]) / closes[0];

      if (dropPct < 0.3) continue;

      const score = scoreStock(data);

      results.push({
        symbol,
        dropPct,
        price: closes[closes.length - 1],
        score
      });

    } catch(e) {
      console.error(symbol, e);
    }
  }

  results.sort((a,b)=>b.score - a.score);

  if (results.length === 0) {
    tbody.innerHTML = "<tr><td colspan='6'>æœªå‘ç°ç¬¦åˆæ¡ä»¶çš„è‚¡ç¥¨</td></tr>";
    return;
  }

  for (const r of results) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${r.symbol}</td>
      <td class="danger">${(r.dropPct*100).toFixed(1)}%</td>
      <td>${r.price.toFixed(2)}</td>
      <td class="score">${r.score}</td>
      <td>${r.score >= 70 ? "âš ï¸ é»‘å¤©é¹…" : "è§‚å¯Ÿ"}</td>
      <td>${r.score >= 70 ? "é«˜é£é™©äº‹ä»¶åæ½œåœ¨åå¼¹" : "è·Œå¹…å¤§ï¼Œéœ€ç»§ç»­è·Ÿè¸ª"}</td>
    `;
    tbody.appendChild(tr);
  }
}
</script>

</body>
</html>
