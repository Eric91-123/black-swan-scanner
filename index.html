<script>
/**
 * V1 数据源方案
 * stooq（免费） + AllOrigins（免费 CORS 代理）
 * 无需 API Key
 */

// 先固定一批美股 Demo（后续可扩展为动态扫描）
const SYMBOLS = [
  { symbol: "AAPL.US", name: "Apple" },
  { symbol: "MSFT.US", name: "Microsoft" },
  { symbol: "TSLA.US", name: "Tesla" },
  { symbol: "AMZN.US", name: "Amazon" },
  { symbol: "META.US", name: "Meta" }
];

// 构造 stooq CSV 地址
function stooqUrl(symbol) {
  return `https://stooq.pl/q/l/?s=${symbol}&f=sd2t2ohlcv&h&e=csv`;
}

// 使用 AllOrigins 解决浏览器 CORS
function corsProxy(url) {
  return `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
}

// 加载股票数据
async function loadStocks() {
  const tbody = document.querySelector("#stockTable tbody");
  tbody.innerHTML = "<tr><td colspan='7'>加载中...</td></tr>";

  tbody.innerHTML = "";

  for (const stock of SYMBOLS) {
    try {
      const res = await fetch(corsProxy(stooqUrl(stock.symbol)));
      const text = await res.text();

      // CSV 解析
      const lines = text.trim().split("\n");
      const values = lines[1].split(",");

      const close = parseFloat(values[6]);
      const open = parseFloat(values[3]);
      const changePct = ((close - open) / open) * 100;

      // 黑天鹅初筛逻辑（V1）
      let swan = "正常波动";
      let conclusion = "未发现极端风险";

      if (changePct < -8) {
        swan = "⚠️ 黑天鹅观察";
        conclusion = "需复盘事件：政策 / 财报 / 行业冲击";
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${stock.symbol.replace(".US", "")}</td>
        <td>${stock.name}</td>
        <td>${close.toFixed(2)}</td>
        <td>${changePct.toFixed(2)}%</td>
        <td>-</td>
        <td class="score">${swan}</td>
        <td>${conclusion}</td>
      `;
      tbody.appendChild(tr);

    } catch (err) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${stock.symbol}</td>
        <td colspan="6">❌ 数据加载失败</td>
      `;
      tbody.appendChild(tr);
    }
  }
}
</script>
